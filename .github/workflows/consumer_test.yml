# *******************************************************************************
# Copyright (c) 2025 Contributors to the Eclipse Foundation
#
# See the NOTICE file(s) distributed with this work for additional
# information regarding copyright ownership.
#
# This program and the accompanying materials are made available under the
# terms of the Apache License Version 2.0 which is available at
# https://www.apache.org/licenses/LICENSE-2.0
#
# SPDX-License-Identifier: Apache-2.0
# *******************************************************************************

name: Consumer Tests
on:
  workflow_call:
  pull_request:
    types: [opened, reopened, synchronize]
  merge_group:
    types: [checks_requested]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        consumer: ["process_description", "score", "module_template"]

    steps:
      - name: Checkout PR
        uses: actions/checkout@v4.2.2

      - name: Prepare Python
        run: |
          bazel run //:ide_support

      - name: Prepare report directory
        run: |
          mkdir -p reports

      # The pipefail ensures that non 0 exit codes inside the pytest execution get carried into the pipe 
      # & make the tests red in the end. Without this we only would check the exit code of the 'tee' command.
      - name: Run Consumer tests (timeout added)
        shell: bash
        run: |
          set -euxo pipefail
          # Kill the whole pytest pipeline if it runs longer than 25 minutes
          timeout --signal=SIGTERM 25m bash -lc '
            set -o pipefail
            .venv_docs/bin/python -m pytest -s -vv src/tests/ \
              --repo="$CONSUMER" \
              --junitxml="reports/${{ matrix.consumer }}.xml" \
              | tee "reports/${{ matrix.consumer }}.log"
          '
        env:
          FORCE_COLOR: "1"
          TERM: xterm-256color
          PYTHONUNBUFFERED: "1"
          CONSUMER: ${{ matrix.consumer }}
      - name: Debug Bazel server log (consumer repo)
        if: always()
        shell: bash
        run: |
          set -euxo pipefail
          BASE="$HOME/.cache/docs_as_code_consumer_tests"
          REPO_DIR="${BASE}/${CONSUMER}"
          echo "CONSUMER=$CONSUMER"
          echo "REPO_DIR=$REPO_DIR"
          ls -la "$BASE" || true
          ls -la "$REPO_DIR" || true
          if [ -d "$REPO_DIR" ]; then
            cd "$REPO_DIR"
            bazel info output_base || true
            bazel info server_log || true
            SERVER_LOG="$(bazel info server_log 2>/dev/null || true)"
            if [ -n "$SERVER_LOG" ] && [ -f "$SERVER_LOG" ]; then
              tail -n 300 "$SERVER_LOG" || true
            fi
          fi
        env:
          CONSUMER: ${{ matrix.consumer }}
      - name: Replay consumer test logs
        if: always()
        run: .venv_docs/bin/python scripts/replay_consumer_test_logs.py consumer_tests.txt


      - name: Upload consumer test report
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: tests-${{ matrix.consumer }}
          path: reports/

  summarize:
    needs: test
    runs-on: ubuntu-latest
    if: ${{ always() }}
    steps:
      - name: Prepare consumer report directory
        run: |
          mkdir -p tests-report

      - name: Download individual consumer reports
        uses: actions/download-artifact@v4
        with:
          pattern: tests-*
          path: tests-report
          merge-multiple: true

      - name: Upload bundled consumer report
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: tests-report
          path: tests-report
